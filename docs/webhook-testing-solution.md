# Stripe Webhook Testing Solution

## Problem Analysis

The Stripe webhook integration tests were failing with 500 errors because the test webhook events generated by `stripe trigger` don't contain the custom metadata that the RestoreClick application expects.

### Root Cause
The webhook handler requires specific data that's not present in generic Stripe CLI test events:
- `session.metadata.session_id` - Internal session ID for image tracking
- `session.customer_details.email` - Customer email address
- `session.payment_intent` - Payment intent ID for order creation

### Error Flow
1. Stripe CLI generates generic test events
2. Webhook handler processes the event
3. Handler fails when trying to extract required metadata
4. Returns 500 error due to missing data

## Solution Overview

We've implemented a multi-layered testing approach:

### 1. **Signature Verification Testing** ✅
- Webhook endpoint correctly validates signatures
- Returns 400 for invalid signatures
- Webhook secret configuration working properly

### 2. **Real Event Testing with Stripe CLI** ⚠️
- Works for signature verification
- Limited by generic test event data
- Useful for integration testing flow

### 3. **Custom Mock Event Testing** ✅
- Created script with application-specific data
- Tests complete webhook processing flow
- Validates business logic with proper metadata

## Testing Scripts

### Basic Webhook Test
```bash
./scripts/test-stripe-webhooks.sh
```
- Sets up ngrok tunnel
- Configures Stripe CLI forwarding
- Triggers generic webhook events
- Good for signature verification testing

### Custom Data Webhook Test
```bash
./scripts/test-webhook-with-custom-data.sh
```
- Sends webhook with required metadata
- Tests complete application flow
- Validates business logic processing

## Webhook Handler Requirements

Your webhook handler expects checkout sessions with:

```json
{
  "customer_details": {
    "email": "customer@example.com",
    "name": "Customer Name"
  },
  "metadata": {
    "session_id": "internal_session_id",
    "batch_id": "batch_identifier"
  },
  "payment_intent": "pi_payment_intent_id",
  "amount_total": 2999,
  "currency": "usd"
}
```

## Production Webhook Setup

### 1. **Stripe Checkout Configuration**
When creating checkout sessions in production, ensure you include:

```javascript
const session = await stripe.checkout.sessions.create({
  // ... other configuration
  metadata: {
    session_id: userSessionId,
    batch_id: batchId,
    // other custom metadata
  },
  customer_email: customerEmail,
  // ... rest of configuration
});
```

### 2. **Webhook Endpoint Configuration**
- Webhook secret: `whsec_f0c11c2d67f08737cd2ead984f3ab7434355c49ada95783ae1d862196a21d122`
- Endpoint URL: `https://your-domain.com/api/webhooks/stripe`
- Events to listen for: `checkout.session.completed`

## Test Results Summary

| Test Type | Status | Notes |
|-----------|--------|-------|
| Signature Verification | ✅ Pass | Correctly validates webhook signatures |
| Environment Configuration | ✅ Pass | All required env vars configured |
| Generic Stripe Events | ⚠️ Limited | Missing application-specific metadata |
| Custom Mock Events | ✅ Pass | Full application flow testing |

## Recommendations

### For Development Testing
1. Use `test-webhook-with-custom-data.sh` for complete flow testing
2. Use `test-stripe-webhooks.sh` for signature verification
3. Mock external services (email, storage) in test environment

### For Production
1. Ensure checkout sessions include required metadata
2. Set up proper webhook endpoint monitoring
3. Implement idempotency checks (already implemented)
4. Add comprehensive error logging (already implemented)

## Next Steps

1. **Unit Tests**: Create unit tests for webhook handler functions
2. **Integration Tests**: Expand integration test suite with database verification
3. **Error Scenarios**: Test various failure modes and edge cases
4. **Performance**: Monitor webhook processing performance
5. **Monitoring**: Set up alerts for webhook failures

## Troubleshooting

### Common Issues
1. **500 Errors**: Check for missing metadata in webhook events
2. **400 Errors**: Verify webhook secret configuration
3. **Database Errors**: Ensure Supabase connection and schema
4. **Storage Errors**: Verify file paths and permissions

### Debug Commands
```bash
# Check webhook logs
tail -f stripe-listen.log

# Test webhook endpoint
curl -X POST http://localhost:3001/api/webhooks/stripe \
  -H "stripe-signature: invalid" \
  -d '{"test": "data"}'

# Check server logs
npm run dev | grep webhook
```

This solution provides a robust foundation for Stripe webhook testing and ensures reliable payment processing in the RestoreClick application.
